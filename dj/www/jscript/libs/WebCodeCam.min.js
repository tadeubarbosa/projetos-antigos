/*!
 * jQuery Plugin WebCodeCam-0.1.0
 * Author: Tóth András
 * Web: http://atandrastoth.co.uk
 * email: atandrastoth@gmail.com
 * Licensed under the MIT license
 */

/*
Included:
barcode decoder (DecoderWorker.js) -> https://github.com/EddieLa/BarcodeReader/blob/master/src/DecoderWorker.js
qr-decoder (qrcodelib.js) -> https://github.com/LazarSoft/jsqrcode
*/
(function(m,t,I,J){function C(a,e){this.element=a;d=m(a);this.options=m.extend({},D,e);this._defaults=D;this._name="WebCodeCam";this.init()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var f=m('<video style="position:absolute;visibility:hidden;display: none;">')[0],n,r=!1,E=!1,k,d,g,h,F=new Worker("/www/jscript/libs/DecoderWorker.js"),l=!1,D={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,videoSource:{id:!0,maxWidth:640,maxHeight:480},flipVertical:!1,flipHorizontal:!1,
zoom:-1,beep:"js/beep.mp3",brightness:0,autoBrightnessValue:!1,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(a,e){}};C.prototype={init:function(){k=this.element.getContext("2d");g=this.options.width;h=this.options.height;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia)navigator.getUserMedia({video:{mandatory:{maxWidth:this.options.videoSource.maxWidth,maxHeight:this.options.videoSource.maxHeight},
optional:[{sourceId:this.options.videoSource.id}]},audio:!1},this.cameraSuccess,this.cameraError);else return alert("Sorry, the browser you are using doesn't support getUserMedia"),!1;return!0},cameraSuccess:function(a){var e=t.URL||t.webkitURL;f.src=e?e.createObjectURL(a):a;f.play()},cameraError:function(a){alert("Something went wrong. (error code "+a.code+")");return!1},setEventListeners:function(){f.addEventListener("canplay",function(a){E||(0<f.videoWidth&&(h=f.videoHeight/(f.videoWidth/g)),d[0].setAttribute("width",
g),d[0].setAttribute("height",h),d.data().plugin_WebCodeCam.options.flipHorizontal&&(k.scale(-1,1),k.translate(-g,0)),d.data().plugin_WebCodeCam.options.flipVertical&&(k.scale(1,-1),k.translate(0,-h)),E=!0,(d.data().plugin_WebCodeCam.options.ReadQRCode||d.data().plugin_WebCodeCam.options.ReadBarecode)&&d.data().plugin_WebCodeCam.delay())},!1);f.addEventListener("play",function(){setInterval(function(){if(!f.paused&&!f.ended){k.clearRect(0,0,g,h);var a=d.data().plugin_WebCodeCam.options.zoom;0>a&&
(a=d.data().plugin_WebCodeCam.optimalZoom());k.drawImage(f,(g*a-g)/-2,(h*a-h)/-2,g*a,h*a);var a=k.getImageData(0,0,g,h),e=d.data().plugin_WebCodeCam.options.brightness,b=d.data().plugin_WebCodeCam.options.grayScale,c=d.data().plugin_WebCodeCam.options.threshold,G=d.data().plugin_WebCodeCam.options.sharpness,H=d.data().plugin_WebCodeCam.options.contrast,y=d.data().plugin_WebCodeCam.options.autoBrightnessValue;b&&(a=d.data().plugin_WebCodeCam.grayScale(a));if(0!=e||0!=y)a=d.data().plugin_WebCodeCam.brightness(a,
e);0!=H&&(a=d.data().plugin_WebCodeCam.contrast(a,H));0!=c&&(a=d.data().plugin_WebCodeCam.threshold(a,c));0!=G.length&&(a=d.data().plugin_WebCodeCam.convolute(a,G));k.putImageData(a,0,0)}},40)},!1)},setCallback:function(){F.onmessage=function(a){l||f.paused||(a.data.success&&1<a.data.result[0].length&&-1==a.data.result[0].indexOf("undefined")?(l=!0,d.data().plugin_WebCodeCam.delay(),d.data().plugin_WebCodeCam.beep(),d.data().plugin_WebCodeCam.options.resultFunction(a.data.result[0],n)):a.data.finished&&
(r=!r,setTimeout(function(){d.data().plugin_WebCodeCam.tryParseBarecode()},320)))};qrcode.callback=function(a){l||f.paused||(l=!0,d.data().plugin_WebCodeCam.delay(),d.data().plugin_WebCodeCam.beep(),d.data().plugin_WebCodeCam.options.resultFunction(a,n))}},tryParseBarecode:function(){var a=1==r?"flip":"normal";n=d[0].toDataURL();var e=k.getImageData(0,0,g,h).data;F.postMessage({ImageData:e,Width:g,Height:h,cmd:a,DecodeNr:1,LowLight:!1})},tryParseQRCode:function(){try{n=d[0].toDataURL(),qrcode.decode()}catch(a){setTimeout(function(){d.data().plugin_WebCodeCam.tryParseQRCode()},
320)}},delay:function(){d.data().plugin_WebCodeCam.cameraPlay()},cameraStop:function(){l=!0;f.pause()},cameraPlay:function(){l=!0;f.play();setTimeout(function(){l=!1;d.data().plugin_WebCodeCam.options.ReadBarecode&&d.data().plugin_WebCodeCam.tryParseBarecode();d.data().plugin_WebCodeCam.options.ReadQRCode&&d.data().plugin_WebCodeCam.tryParseQRCode()},2E3)},getLastImageSrc:function(){return n},optimalZoom:function(a){return f.videoHeight/h},getImageLightness:function(){pixels=k.getImageData(0,0,g,
h);for(var a=pixels.data,e=0,b,c,d,f=0,y=a.length;f<y;f+=4)b=a[f],c=a[f+1],d=a[f+2],b=Math.floor((b+c+d)/3),e+=b;return Math.floor(e/(g*h))},brightness:function(a,e){e=0==e&&0!=this.options.autoBrightnessValue?this.options.autoBrightnessValue-this.getImageLightness():e;for(var b=a.data,c=0;c<b.length;c+=4)b[c]+=e,b[c+1]+=e,b[c+2]+=e;return a},grayScale:function(a){for(var e=a.data,b=0;b<e.length;b+=4)e[b]=e[b+1]=e[b+2]=.2126*e[b]+.7152*e[b+1]+.0722*e[b+2];return a},contrast:function(a,e){for(var b=
a.data,c=0;c<b.length;c+=4){e=10;var d=Math.round((b[c]+b[c+1]+b[c+2])/3);127<d?(b[c]+=b[c]/d*e,b[c+1]+=b[c+1]/d*e,b[c+2]+=b[c+2]/d*e):(b[c]-=b[c]/d*e,b[c+1]-=b[c+1]/d*e,b[c+2]-=b[c+2]/d*e)}return a},threshold:function(a,d){for(var b=a.data,c=0,f=g*h*4;c<f;c+=4)ave=b[c]+b[c+1]+b[c+2],b[c]=ave<d?b[c+1]=b[c+2]=0:b[c+1]=b[c+2]=255,b[c+3]=255;return a},convolute:function(a,d,b){var c=Math.round(Math.sqrt(d.length)),f=Math.floor(c/2),h=a.data,g=a.width;a=a.height;var k=I.createElement("canvas").getContext("2d").createImageData(g,
a),l=k.data;b=b?1:0;for(var m=0;m<a;m++)for(var n=0;n<g;n++){for(var r=m,t=n,u=4*(m*g+n),z=0,A=0,B=0,v=0,w=0;w<c;w++)for(var x=0;x<c;x++){var p=r+w-f,q=t+x-f;0<=p&&p<a&&0<=q&&q<g&&(p=4*(p*g+q),q=d[w*c+x],z+=h[p]*q,A+=h[p+1]*q,B+=h[p+2]*q,v+=h[p+3]*q)}l[u]=z;l[u+1]=A;l[u+2]=B;l[u+3]=v+b*(255-v)}return k},beep:function(){if("string"==typeof this.options.beep){var a=this.options.beep;setTimeout(function(){(new Audio(a)).play()},0)}}};m.fn.WebCodeCam=function(a){return this.each(function(){m.data(this,
"plugin_WebCodeCam")||m.data(this,"plugin_WebCodeCam",new C(this,a))})}})(jQuery,window,document);